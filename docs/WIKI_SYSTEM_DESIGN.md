# Wiki形式物語世界データベースシステム設計

最終更新: 2025-08-30

## 概要

従来の「キャラクター管理」を超えた、包括的な物語世界データベースシステム。ファンサイトWikiのような体験を提供し、物語進行に応じて自動的に項目が追加・更新される没入型システム。

## システムアーキテクチャ

### コアコンポーネント構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Novel Editor Frontend                    │
├─────────────────┬─────────────────┬─────────────────────────┤
│   Scene Panel   │  Editor Panel   │    Wiki Panel           │
│                 │                 │                         │
│ • Scene List    │ • Tiptap Editor │ • Entry Browser         │
│ • Scene Nav     │ • Slash Commands│ • Tag Filter            │
│ • Scene Meta    │ • Preview       │ • Search                │
│                 │                 │ • Related Entries       │
└─────────────────┴─────────────────┴─────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                    State Management Layer                   │
├─────────────────┬─────────────────┬─────────────────────────┤
│  Scene Store    │  Editor Store   │    Wiki Store           │
│                 │                 │                         │
│ • Scene CRUD    │ • Document      │ • Entry CRUD            │
│ • Scene Order   │ • HTML/JSON     │ • Tag Management        │
│ • Scene Meta    │ • Zen Mode      │ • Auto-Update Queue     │
│                 │                 │ • Relation Graph        │
└─────────────────┴─────────────────┴─────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                    Wiki Engine Core                         │
├─────────────────┬─────────────────┬─────────────────────────┤
│ Entry Parser    │ Auto-Extractor  │  Relation Engine        │
│                 │                 │                         │
│ • Markdown      │ • NLP Analysis  │ • Tag-based Links       │
│ • Rich Content  │ • Entity Detect │ • Semantic Relations    │
│ • Metadata      │ • Context Track │ • Graph Traversal       │
│ • Versioning    │ • AI Integration│ • Recommendation        │
└─────────────────┴─────────────────┴─────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                    Data Persistence                         │
├─────────────────┬─────────────────┬─────────────────────────┤
│  Local Storage  │   IndexedDB     │    Future: Backend      │
│                 │                 │                         │
│ • Quick Access  │ • Full-text     │ • Cloud Sync            │
│ • Session Data  │ • Binary Assets │ • Collaboration         │
│ • Preferences   │ • Version Hist  │ • AI Services           │
└─────────────────┴─────────────────┴─────────────────────────┘
```

## データモデル設計（UML クラス図）

### WikiEntry エンティティ

```typescript
interface WikiEntry {
  id: string                    // UUID
  title: string                 // エントリタイトル
  slug: string                  // URL-safe identifier
  content: WikiContent          // リッチコンテンツ
  tags: string[]               // タグ配列
  category: EntryCategory      // カテゴリ
  metadata: EntryMetadata      // メタデータ
  relations: EntryRelation[]   // 関連エントリ
  versions: EntryVersion[]     // バージョン履歴
  autoGenerated: boolean       // 自動生成フラグ
  createdAt: Date
  updatedAt: Date
  lastReadAt?: Date           // 最終閲覧日時
}

interface WikiContent {
  markdown: string            // Markdown本文
  summary: string            // 要約
  infobox?: InfoboxData      // 情報ボックス
  gallery?: MediaItem[]      // 画像ギャラリー
  quotes?: Quote[]           // 引用・名言
  rumors?: Rumor[]           // ルーモア・噂
  authorVoice?: AuthorPost[] // キャラクター執筆
}

interface EntryMetadata {
  readCount: number          // 閲覧回数
  importance: number         // 重要度スコア (0-100)
  spoilerLevel: number       // ネタバレレベル
  firstMentionScene?: string // 初出シーン
  lastUpdateScene?: string   // 最終更新シーン
  extractionSource: string[] // 抽出元テキスト
}

enum EntryCategory {
  CHARACTER = 'character',    // キャラクター
  LOCATION = 'location',      // 場所・地名
  ITEM = 'item',             // アイテム・道具
  EVENT = 'event',           // 出来事・事件
  CONCEPT = 'concept',       // 概念・設定
  ORGANIZATION = 'organization', // 組織・団体
  TIMELINE = 'timeline',     // 時系列・章
  LORE = 'lore',            // 世界観・伝承
  META = 'meta'             // メタ情報
}

interface EntryRelation {
  targetId: string          // 関連先エントリID
  relationType: RelationType // 関係性タイプ
  strength: number          // 関係の強さ (0-1)
  description?: string      // 関係の説明
  bidirectional: boolean    // 双方向関係か
}

enum RelationType {
  APPEARS_WITH = 'appears_with',     // 共に登場
  LOCATED_IN = 'located_in',         // 場所関係
  BELONGS_TO = 'belongs_to',         // 所属関係
  RELATED_TO = 'related_to',         // 一般的関連
  CAUSED_BY = 'caused_by',           // 因果関係
  PART_OF = 'part_of',              // 部分関係
  SIMILAR_TO = 'similar_to',         // 類似関係
  OPPOSITE_TO = 'opposite_to'        // 対立関係
}
```

### 没入型投稿システム

```typescript
interface AuthorPost {
  id: string
  authorId: string          // 執筆者（キャラクター）ID
  authorName: string        // 執筆者名
  authorRole: AuthorRole    // 執筆者の役割
  content: string          // 投稿内容
  style: PostStyle         // 投稿スタイル
  timestamp: Date          // 投稿日時（物語内時間）
  mood?: string           // 執筆時の気分・状況
  reliability: number      // 信頼性 (0-1)
}

enum AuthorRole {
  CHARACTER = 'character',     // キャラクター本人
  NARRATOR = 'narrator',       // ナレーター
  HISTORIAN = 'historian',     // 歴史家・記録者
  WITNESS = 'witness',         // 目撃者
  RUMOR_MILL = 'rumor_mill',  // 噂の発信源
  SCHOLAR = 'scholar',         // 学者・研究者
  JOURNALIST = 'journalist'    // ジャーナリスト
}

enum PostStyle {
  FORMAL = 'formal',           // 公式記録
  CASUAL = 'casual',           // カジュアル
  DIARY = 'diary',            // 日記風
  LETTER = 'letter',          // 手紙風
  REPORT = 'report',          // 報告書
  GOSSIP = 'gossip',          // 噂話
  POETRY = 'poetry',          // 詩的表現
  TECHNICAL = 'technical'      // 技術文書
}

interface Rumor {
  id: string
  content: string
  source?: string          // 噂の出所
  veracity: number        // 真実性 (0-1)
  spreadLevel: number     // 拡散度
  relatedEntries: string[] // 関連エントリ
  firstHeard: Date        // 初出日時
}
```

## 自動抽出・更新システム

### NLP分析パイプライン

```typescript
interface AutoExtractionEngine {
  // テキスト解析
  analyzeText(content: string, context: AnalysisContext): ExtractedEntities
  
  // エンティティ抽出
  extractEntities(text: string): EntityCandidate[]
  
  // 関係性推論
  inferRelations(entities: EntityCandidate[]): RelationCandidate[]
  
  // 既存エントリとの統合
  mergeWithExisting(candidates: EntityCandidate[]): MergeOperation[]
}

interface AnalysisContext {
  currentScene: string
  previousScenes: string[]
  existingEntries: WikiEntry[]
  userPreferences: ExtractionPreferences
}

interface EntityCandidate {
  text: string              // 抽出されたテキスト
  category: EntryCategory   // 推定カテゴリ
  confidence: number        // 信頼度
  context: string          // 周辺文脈
  suggestedTags: string[]  // 推奨タグ
  existingMatch?: string   // 既存エントリとのマッチ
}

interface ExtractionPreferences {
  autoCreateThreshold: number    // 自動作成の閾値
  updateExistingEntries: boolean // 既存エントリの更新
  notifyOnNewEntries: boolean   // 新規エントリ通知
  preferredCategories: EntryCategory[] // 優先カテゴリ
}
```

## ユーザーインターフェース設計

### Wiki Panel レイアウト

```
┌─────────────────────────────────────────────────────────┐
│ Wiki Panel                                         [×]  │
├─────────────────────────────────────────────────────────┤
│ 🔍 [Search entries...]           [🏷️ Tags] [⚙️ Settings] │
├─────────────────────────────────────────────────────────┤
│ 📂 Categories                                           │
│ ├─ 👤 Characters (12)                                  │
│ ├─ 🏛️ Locations (8)                                    │
│ ├─ 📜 Events (15)                                      │
│ ├─ 💎 Items (6)                                        │
│ └─ 🌟 Concepts (9)                                     │
├─────────────────────────────────────────────────────────┤
│ 📋 Recent Entries                                      │
│ • [Auto] 🆕 "古い図書館" - 2分前                        │
│ • [User] ✏️ "主人公の過去" - 5分前                      │
│ • [Auto] 🔄 "謎の手紙" updated - 10分前                 │
├─────────────────────────────────────────────────────────┤
│ 🎯 Current Scene Relations                             │
│ • "図書館の司書" (character)                            │
│ • "禁書エリア" (location)                              │
│ • "古代の魔導書" (item)                                │
└─────────────────────────────────────────────────────────┘
```

### Entry Detail View

```
┌─────────────────────────────────────────────────────────┐
│ 📖 Entry: "エリア・フォンテーヌ"                        │
├─────────────────────────────────────────────────────────┤
│ 🏷️ Tags: #character #protagonist #mysterious #academy   │
│ 📊 Importance: ████████░░ (8/10)  👁️ Views: 23         │
├─────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 📋 Info Box                                         │ │
│ │ Age: 17                                            │ │
│ │ Affiliation: Royal Academy                         │ │
│ │ First Appearance: Chapter 1                        │ │
│ │ Voice Actor: [TBD]                                 │ │
│ └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│ ## 概要                                                 │
│ 王立学院の2年生。謎めいた過去を持つ少女で...            │
│                                                         │
│ ## 外見                                                 │
│ 銀髪に青い瞳。いつも古い本を持ち歩いている...           │
│                                                         │
│ ## 💬 キャラクター投稿                                  │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 👤 エリア・フォンテーヌ (本人) - 3時間前             │ │
│ │ 📝 日記風                                           │ │
│ │                                                     │ │
│ │ "今日も図書館で過ごした。あの本のことが気になって   │ │
│ │  仕方がない。司書さんは何か知っているのかしら..."   │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ## 🗣️ 噂・ルーモア                                      │
│ • "彼女は実は王族の血を引いている" (信頼度: 30%)        │
│ • "深夜に図書館で光る本を読んでいた" (信頼度: 70%)      │
│                                                         │
│ ## 🔗 関連項目                                          │
│ • 王立学院 (所属)                                       │
│ • 古い図書館 (よく訪れる)                               │
│ • 謎の魔導書 (関心を持つ)                               │
│ • リオン・ハートウェル (クラスメート)                   │
└─────────────────────────────────────────────────────────┘
```

## 技術実装戦略

### フェーズ1: コアWikiシステム
1. **WikiEntry データ構造の実装**
2. **基本CRUD操作**
3. **タグシステム**
4. **検索・フィルタリング**

### フェーズ2: 自動抽出機能
1. **簡易NLP（正規表現ベース）**
2. **エンティティ候補抽出**
3. **ユーザー承認フロー**
4. **既存エントリとの統合**

### フェーズ3: 没入型機能
1. **キャラクター投稿システム**
2. **ルーモア・噂システム**
3. **関係性グラフ可視化**
4. **AI統合（将来）**

## 既存システムとの統合

### Scene Management との連携
- シーン切り替え時に関連Wikiエントリを表示
- シーン内容変更時に自動抽出を実行
- シーンメタデータとWikiエントリの相互参照

### Editor との連携
- エディタ内でWikiエントリへのリンク挿入
- 入力中のリアルタイム関連項目提示
- Slashコマンドでのエントリ参照・作成

### Preview との連携
- プレビュー表示時に関連Wikiエントリをサイドに表示
- Wikiエントリからのプレビュージャンプ
- 読者視点でのWiki体験

## データフロー図

```
[User Input] → [Editor] → [Auto-Extractor] → [Entity Candidates]
                   ↓              ↓               ↓
[Scene Store] ← [Wiki Store] → [Relation Engine] → [UI Updates]
                   ↓              ↓               ↓
[Local Storage] ← [IndexedDB] → [Search Index] → [User Interface]
```

この設計により、従来の「キャラクター管理」を超えた、包括的で没入感のある物語世界データベースシステムを構築できます。
