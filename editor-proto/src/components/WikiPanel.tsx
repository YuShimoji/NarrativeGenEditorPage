import React, { useState } from 'react'
import { useWikiStore, EntryCategory } from '../store/useWikiStore'

const CATEGORY_ICONS: Record<EntryCategory, string> = {
  [EntryCategory.CHARACTER]: 'ğŸ‘¤',
  [EntryCategory.LOCATION]: 'ğŸ›ï¸',
  [EntryCategory.ITEM]: 'ğŸ’',
  [EntryCategory.EVENT]: 'ğŸ“œ',
  [EntryCategory.CONCEPT]: 'ğŸŒŸ',
  [EntryCategory.ORGANIZATION]: 'ğŸ¢',
  [EntryCategory.TIMELINE]: 'ğŸ“…',
  [EntryCategory.LORE]: 'ğŸ“š',
  [EntryCategory.META]: 'âš™ï¸'
}

const CATEGORY_LABELS: Record<EntryCategory, string> = {
  [EntryCategory.CHARACTER]: 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼',
  [EntryCategory.LOCATION]: 'å ´æ‰€',
  [EntryCategory.ITEM]: 'ã‚¢ã‚¤ãƒ†ãƒ ',
  [EntryCategory.EVENT]: 'å‡ºæ¥äº‹',
  [EntryCategory.CONCEPT]: 'æ¦‚å¿µ',
  [EntryCategory.ORGANIZATION]: 'çµ„ç¹”',
  [EntryCategory.TIMELINE]: 'æ™‚ç³»åˆ—',
  [EntryCategory.LORE]: 'ä¸–ç•Œè¦³',
  [EntryCategory.META]: 'ãƒ¡ã‚¿'
}

export const WikiPanel: React.FC = () => {
  const {
    searchQuery,
    selectedCategory,
    showAutoGenerated,
    selectedEntryId,
    setSearchQuery,
    setSelectedCategory,
    toggleShowAutoGenerated,
    selectEntry,
    getFilteredEntries,
    getCategoryCount,
    getAllTags
  } = useWikiStore()

  const [showCategories, setShowCategories] = useState(true)
  const [showRecentEntries, setShowRecentEntries] = useState(true)

  const filteredEntries = getFilteredEntries()
  const recentEntries = filteredEntries.slice(0, 5)
  const allTags = getAllTags()

  const handleCategoryClick = (category: EntryCategory) => {
    setSelectedCategory(selectedCategory === category ? null : category)
  }

  const formatTimeAgo = (date: Date) => {
    const now = new Date()
    const diffMs = now.getTime() - date.getTime()
    const diffMins = Math.floor(diffMs / (1000 * 60))
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60))
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

    if (diffMins < 1) return 'ãŸã£ãŸä»Š'
    if (diffMins < 60) return `${diffMins}åˆ†å‰`
    if (diffHours < 24) return `${diffHours}æ™‚é–“å‰`
    return `${diffDays}æ—¥å‰`
  }

  return (
    <div className="wiki-panel">
      <div className="wiki-panel-header">
        <h3>Wiki</h3>
        <div className="wiki-header-actions">
          <button
            className={`wiki-toggle-btn ${showAutoGenerated ? 'active' : ''}`}
            onClick={toggleShowAutoGenerated}
            title="è‡ªå‹•ç”Ÿæˆé …ç›®ã®è¡¨ç¤ºåˆ‡æ›¿"
          >
            ğŸ¤–
          </button>
        </div>
      </div>

      {/* Search */}
      <div className="wiki-search">
        <input
          type="text"
          placeholder="ã‚¨ãƒ³ãƒˆãƒªã‚’æ¤œç´¢..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="wiki-search-input"
        />
      </div>

      {/* Categories */}
      <div className="wiki-section">
        <div 
          className="wiki-section-header"
          onClick={() => setShowCategories(!showCategories)}
        >
          <span>ğŸ“‚ ã‚«ãƒ†ã‚´ãƒª</span>
          <span className="wiki-section-toggle">
            {showCategories ? 'â–¼' : 'â–¶'}
          </span>
        </div>
        {showCategories && (
          <div className="wiki-categories">
            {Object.values(EntryCategory).map(category => {
              const count = getCategoryCount(category)
              if (count === 0) return null
              
              return (
                <div
                  key={category}
                  className={`wiki-category-item ${selectedCategory === category ? 'active' : ''}`}
                  onClick={() => handleCategoryClick(category)}
                >
                  <span className="wiki-category-icon">
                    {CATEGORY_ICONS[category]}
                  </span>
                  <span className="wiki-category-label">
                    {CATEGORY_LABELS[category]}
                  </span>
                  <span className="wiki-category-count">
                    ({count})
                  </span>
                </div>
              )
            })}
          </div>
        )}
      </div>

      {/* Recent Entries */}
      <div className="wiki-section">
        <div 
          className="wiki-section-header"
          onClick={() => setShowRecentEntries(!showRecentEntries)}
        >
          <span>ğŸ“‹ æœ€è¿‘ã®ã‚¨ãƒ³ãƒˆãƒª</span>
          <span className="wiki-section-toggle">
            {showRecentEntries ? 'â–¼' : 'â–¶'}
          </span>
        </div>
        {showRecentEntries && (
          <div className="wiki-recent-entries">
            {recentEntries.length === 0 ? (
              <div className="wiki-empty-state">
                ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚Šã¾ã›ã‚“
              </div>
            ) : (
              recentEntries.map(entry => (
                <div
                  key={entry.id}
                  className={`wiki-entry-item ${selectedEntryId === entry.id ? 'active' : ''}`}
                  onClick={() => selectEntry(entry.id)}
                >
                  <div className="wiki-entry-header">
                    <span className="wiki-entry-type">
                      {entry.autoGenerated ? '[Auto]' : '[User]'}
                    </span>
                    <span className="wiki-entry-icon">
                      {entry.autoGenerated ? 'ğŸ†•' : 'âœï¸'}
                    </span>
                    <span className="wiki-entry-time">
                      {formatTimeAgo(entry.updatedAt)}
                    </span>
                  </div>
                  <div className="wiki-entry-title">
                    "{entry.title}"
                  </div>
                  <div className="wiki-entry-summary">
                    {entry.content.summary}
                  </div>
                </div>
              ))
            )}
          </div>
        )}
      </div>

      {/* Search Results */}
      {searchQuery && (
        <div className="wiki-section">
          <div className="wiki-section-header">
            <span>ğŸ” æ¤œç´¢çµæœ ({filteredEntries.length}ä»¶)</span>
          </div>
          <div className="wiki-search-results">
            {filteredEntries.map(entry => (
              <div
                key={entry.id}
                className={`wiki-entry-item ${selectedEntryId === entry.id ? 'active' : ''}`}
                onClick={() => selectEntry(entry.id)}
              >
                <div className="wiki-entry-header">
                  <span className="wiki-entry-category">
                    {CATEGORY_ICONS[entry.category]}
                  </span>
                  <span className="wiki-entry-importance">
                    {'â˜…'.repeat(Math.floor(entry.metadata.importance / 20))}
                  </span>
                </div>
                <div className="wiki-entry-title">
                  {entry.title}
                </div>
                <div className="wiki-entry-tags">
                  {entry.tags.slice(0, 3).map(tag => (
                    <span key={tag} className="wiki-tag">
                      #{tag}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Quick Add */}
      <div className="wiki-quick-actions">
        <button className="wiki-add-btn" title="æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ">
          + ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
        </button>
      </div>
    </div>
  )
}
